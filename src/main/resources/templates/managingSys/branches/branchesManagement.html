<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"  layout:decorate="~{layout}">
<!--       layout:decorate="~{SysMain}"> -->
<head>
    <title>매장 관리 - Happy Jelly 관리시스템</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/boxicons@2.0.7/css/boxicons.min.css" rel="stylesheet">
<!--     <meta name="_csrf" th:content="${_csrf.token}"/> -->
<!--     <meta name="_csrf_header" th:content="${_csrf.headerName}"/> -->
</head>
<body>
    <div layout:fragment="content">
        <div class="container-fluid">
            <div class="row">
                <!-- 사이드바 -->
                <nav class="sidebar" id="sidebar">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="/managingSys/branches">
                                <i class='bx bx-store'></i> 매장 관리
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="/managingSys/staff">
                                <i class='bx bx-user'></i> 직원 관리
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/managingSys/member">
                                <i class='bx bx-group'></i> 회원 관리
                            </a>
                        </li>
                    </ul>
                </nav>
                
        <!-- 메인 컨텐츠 -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">매장 관리</h5>
                <a th:href="@{/managingSys/branches/register}" class="btn btn-primary">
                    <i class='bx bx-plus-circle'></i> 새 매장 등록
                </a>
            </div>
            <div class="card-body">
                <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>
                <div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>

                <div class="mb-3">
                    <form th:action="@{/branches}" method="get">
                        <input type="text" id="searchInput" name="keyword" class="form-control" placeholder="매장명, 주소로 검색" th:value="${keyword}">
<!--                         <button type="submit" class="btn btn-primary mt-2">검색</button> -->
                    </form>
                </div>

                <div th:if="${branchList != null and not #lists.isEmpty(branchList)}">
                    <table class="table table-hover" id="branchTable">
                        <thead>
                            <tr>
                                <th>매장 ID</th>
                                <th>매장명</th>
                                <th>주소</th>
                                <th>전화번호</th>
                                <th>운영 상태</th>
                                <th>작업</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="branch : ${branchList}">
                                <td th:text="${branch.branchId}"></td>
                                <td th:text="${branch.branchesName}"></td>
                                <td th:text="${branch.address}"></td>
                                <td th:text="${branch.phone}"></td>
                                <td>
                                    <span th:text="${branch.active ? '활성' : '비활성'}"
                                          th:class="${branch.active ? 'badge bg-success' : 'badge bg-danger'}">
                                    </span>
                                </td>
                                <td>
                                    <a th:href="@{'/managingSys/branches/edit/' + ${branch.branchId}}" class="btn btn-sm btn-outline-primary">
                                        <i class='bx bx-edit-alt'></i> 수정
                                    </a>
                                    <form th:action="@{'/managingSys/branches/toggle-status/' + ${branch.branchId}}" method="post" style="display: inline;">
<!--                                         <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" /> -->
                                        <button type="submit" class="btn btn-sm btn-outline-warning">
                                            <i class='bx bx-power-off'></i> 상태 변경
                                        </button>
                                    </form>
                                    <form th:action="@{'/managingSys/branches/delete/' + ${branch.branchId}}" method="post" style="display: inline;">
<!--                                         <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" /> -->
                                        <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('정말로 삭제하시겠습니까?');">
                                            <i class='bx bx-trash'></i> 삭제
                                        </button>
                                    </form>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div th:if="${branchList == null or #lists.isEmpty(branchList)}">
                    <p>등록된 매장이 없습니다.</p>
                </div>
            </div>
        </div>
    </main>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
$(document).ready(function() {
    var token = $("meta[name='_csrf']").attr("content");
    var header = $("meta[name='_csrf_header']").attr("content");
    
    if (token && header) {
        $(document).ajaxSend(function(e, xhr, options) {
            xhr.setRequestHeader(header, token);
        });
    }

    // 검색 기능
    $("#searchInput").on("keyup", function() {
        var value = $(this).val().toLowerCase();
        $("#branchTable tbody tr").filter(function() {
            $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
        });
    });

    // 상태 변경 기능
    $(".toggle-status-btn").click(function(e) {
        e.preventDefault();
        var id = $(this).data('id');
        toggleBranchStatus(id, this);
    });

    // 삭제 기능
    $(".delete-branch-btn").click(function(e) {
        e.preventDefault();
        var id = $(this).data('id');
        if (confirm('정말로 이 매장을 삭제하시겠습니까?')) {
            deleteBranch(id, this);
        }
    });
});

function toggleBranchStatus(id, button) {
    $.ajax({
        url: '/managingSys/branches/toggle-status/' + id,
        type: 'POST',
        success: function(response) {
            var statusSpan = $(button).closest('tr').find('td:nth-child(7) span');
            if (response.active) {
                statusSpan.removeClass('bg-danger').addClass('bg-success').text('활성');
            } else {
                statusSpan.removeClass('bg-success').addClass('bg-danger').text('비활성');
            }
        },
        error: function(xhr, status, error) {
            alert('매장 상태 변경에 실패했습니다: ' + xhr.responseText);
        }
    });
}

function deleteBranch(id, button) {
    $.ajax({
        url: '/managingSys/branches/delete/' + id,
        type: 'POST',
        success: function(response) {
            $(button).closest('tr').remove();
        },
        error: function(xhr, status, error) {
            alert('매장 삭제에 실패했습니다: ' + xhr.responseText);
        }
    });
}
</script>
</body>
</html>